[
  {
    "schema_documentation": "# DATABASE SCHEMA\n\n---\n\n## categories\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- slug `text` NOT NULL\n\n- label `text` NOT NULL\n\n- is_active `boolean` NOT NULL\n\n- sort_order `integer(32)` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## category_patterns\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- category_id `uuid` NOT NULL\n\n- pattern `text` NOT NULL\n\n- flags `text` NOT NULL\n\n- priority `integer(32)` NOT NULL\n\n- is_active `boolean` NOT NULL\n\n## config\n- key `text` NOT NULL **PRIMARY KEY**\n\n- value `jsonb` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## doc_chunks\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- source_id `uuid` NOT NULL\n\n- chunk_index `integer(32)` NOT NULL\n\n- content `text`\n\n- section_anchor `text`\n\n- start_time_seconds `integer(32)`\n\n- end_time_seconds `integer(32)`\n\n- van_models `ARRAY`\n\n- keywords `tsvector`\n\n- metadata `jsonb`\n\n- created_at `timestamp with time zone` NOT NULL\n\n## doc_sequences\n- sequence_key `text` NOT NULL **PRIMARY KEY**\n\n- step_num `integer(32)` NOT NULL **PRIMARY KEY**\n\n- message_template `text` NOT NULL\n\n- doc_url `text`\n\n- doc_title `text`\n\n- wait_for_response `boolean`\n\n- success_triggers `ARRAY`\n\n- failure_triggers `ARRAY`\n\n- timeout_minutes `integer(32)`\n\n- on_success `text`\n\n- on_failure `text`\n\n- on_timeout `text`\n\n- handoff_playbook_key `text`\n\n- created_at `timestamp with time zone`\n\n- van_makes `ARRAY`\n\n- years `ARRAY`\n\n- van_versions `ARRAY`\n\n- handoff_sequence_key `text`\n\n- handoff_trigger `text`\n\n- is_active `boolean` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## doc_sources\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- title `text` NOT NULL\n\n- type `text` NOT NULL\n\n- uri `text` NOT NULL\n\n- van_models `ARRAY`\n\n- metadata `jsonb`\n\n- uploaded_at `timestamp with time zone` NOT NULL\n\n## emergency_rules\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- name `text`\n\n- pattern `text` NOT NULL\n\n- flags `text` NOT NULL\n\n- scope `text` NOT NULL\n\n- playbook_key `text`\n\n- hazard_key `text`\n\n- description `text`\n\n- is_active `boolean` NOT NULL\n\n- priority `integer(32)` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## escalations\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- session_id `uuid`\n\n- reason `text` NOT NULL\n\n- target_phone `text` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n## links_sent\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- session_id `uuid`\n\n- to_phone `text` NOT NULL\n\n- url `text` NOT NULL\n\n- caption `text`\n\n- sent_via `text` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n## owners\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- name `text` NOT NULL\n\n- company `text`\n\n- phone `text` NOT NULL\n\n- email `text` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## playbook_forms_submissions\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- submitted_by `text`\n\n- category_id `uuid`\n\n- raw_answers `jsonb` NOT NULL\n\n- generated_playbook_json `jsonb`\n\n- status `text` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## playbook_topic_patterns\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- category_slug `text` NOT NULL\n\n- playbook_key `text` NOT NULL\n\n- pattern `text` NOT NULL\n\n- flags `text`\n\n- priority `integer(32)`\n\n- is_active `boolean`\n\n- entry_step_id `text`\n\n## playbook_topic_patterns_backup\n- id `uuid`\n\n- category_slug `text`\n\n- playbook_key `text`\n\n- pattern `text`\n\n- flags `text`\n\n- priority `integer(32)`\n\n- is_active `boolean`\n\n- entry_step_id `text`\n\n## playbooks_draft\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- title `text` NOT NULL\n\n- category_id `uuid`\n\n- applies_to `ARRAY`\n\n- entry_selector `jsonb`\n\n- body_json `jsonb` NOT NULL\n\n- author `text`\n\n- status `text` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## playbooks_published\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- playbook_key `text` NOT NULL\n\n- version `integer(32)` NOT NULL\n\n- category_id `uuid`\n\n- applies_to `ARRAY`\n\n- entry_selector `jsonb`\n\n- body_json `jsonb` NOT NULL\n\n- is_active `boolean` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- created_by `text`\n\n## quick_responses\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- pattern `text` NOT NULL\n\n- category_slug `text`\n\n- doc_url `text` NOT NULL\n\n- doc_title `text` NOT NULL\n\n- message_template `text` NOT NULL\n\n- priority `integer(32)`\n\n- success_rate `double precision(53)`\n\n- usage_count `integer(32)`\n\n- is_active `boolean`\n\n- created_at `timestamp with time zone`\n\n## roles\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- name `text` NOT NULL\n\n- description `text`\n\n- permissions `jsonb`\n\n- created_at `timestamp with time zone`\n\n## sequence_parts\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- sequence_key `text` NOT NULL\n\n- part_name `text` NOT NULL\n\n- part_number `text`\n\n- part_description `text`\n\n- part_link `text`\n\n- estimated_price `numeric(10)`\n\n- is_required `boolean`\n\n- sort_order `integer(32)`\n\n- created_at `timestamp with time zone`\n\n- updated_at `timestamp with time zone`\n\n- step_num `integer(32)`\n\n## sequence_sessions\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- session_id `uuid`\n\n- phone_number `text` NOT NULL\n\n- sequence_key `text` NOT NULL\n\n- current_step `integer(32)`\n\n- attempts `jsonb`\n\n- docs_sent `ARRAY`\n\n- status `text`\n\n- started_at `timestamp with time zone`\n\n- last_interaction `timestamp with time zone`\n\n- completed_at `timestamp with time zone`\n\n- van_id `uuid`\n\n- handoff_count `integer(32)`\n\n## sequence_step_responses\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- sequence_session_id `uuid` NOT NULL\n\n- step_num `integer(32)` NOT NULL\n\n- response_text `text`\n\n- response_category `text`\n\n- source `text`\n\n- responded_at `timestamp with time zone`\n\n## sequence_tools\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- sequence_key `text` NOT NULL\n\n- tool_name `text` NOT NULL\n\n- tool_description `text`\n\n- tool_link `text`\n\n- is_required `boolean`\n\n- sort_order `integer(32)`\n\n- created_at `timestamp with time zone`\n\n- updated_at `timestamp with time zone`\n\n- step_num `integer(32)`\n\n## sequences_metadata\n- sequence_key `text` NOT NULL **PRIMARY KEY**\n\n- display_name `text` NOT NULL\n\n- description `text`\n\n- category `text`\n\n- is_active `boolean` NOT NULL\n\n- created_by `text`\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n- sort_order `integer(32)`\n\n- estimated_duration_minutes `integer(32)`\n\n- icon `text`\n\n- tags `ARRAY`\n\n## session_events\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- session_id `uuid` NOT NULL\n\n- step_id `text`\n\n- event_type `USER-DEFINED` NOT NULL\n\n- payload `jsonb`\n\n- latency_ms `integer(32)`\n\n- created_at `timestamp with time zone` NOT NULL\n\n## session_paths\n- session_id `uuid` NOT NULL **PRIMARY KEY**\n\n- playbook_key `text`\n\n- version `integer(32)`\n\n- step_sequence `ARRAY` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n## sessions\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n## sessions\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- call_id `text` NOT NULL\n\n- owner_id `uuid`\n\n- van_id `uuid`\n\n- recognized_caller `boolean` NOT NULL\n\n- current_playbook_key `text`\n\n- current_step_id `text`\n\n- state `jsonb` NOT NULL\n\n- status `USER-DEFINED` NOT NULL\n\n- started_at `timestamp with time zone` NOT NULL\n\n- ended_at `timestamp with time zone`\n\n- ended_reason `USER-DEFINED`\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## sms_messages\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- session_id `uuid`\n\n- sequence_session_id `uuid`\n\n- from_phone `text` NOT NULL\n\n- to_phone `text` NOT NULL\n\n- message_body `text` NOT NULL\n\n- direction `text`\n\n- twilio_sid `text`\n\n- twilio_status `text`\n\n- processed `boolean`\n\n- processed_at `timestamp with time zone`\n\n- created_at `timestamp with time zone`\n\n## sms_routing_state\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- phone_number `text` NOT NULL\n\n- state `text` NOT NULL\n\n- pending_action `jsonb`\n\n- conversation_options `jsonb`\n\n- selected_conversation_id `uuid`\n\n- selected_conversation_type `text`\n\n- confirmation_attempts `integer(32)`\n\n- original_message `text`\n\n- created_at `timestamp with time zone`\n\n- updated_at `timestamp with time zone`\n\n- expires_at `timestamp with time zone`\n\n## step_handoff_triggers\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- sequence_key `text` NOT NULL\n\n- step_num `integer(32)` NOT NULL\n\n- trigger_label `text` NOT NULL\n\n- target_sequence_key `text` NOT NULL\n\n- sort_order `integer(32)`\n\n- is_active `boolean`\n\n- created_at `timestamp with time zone`\n\n- updated_at `timestamp with time zone`\n\n## subcategories\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- category_id `uuid` NOT NULL\n\n- slug `text` NOT NULL\n\n- label `text` NOT NULL\n\n- is_active `boolean` NOT NULL\n\n- sort_order `integer(32)` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## symptom_archetypes\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- category_id `uuid`\n\n- subcategory_id `uuid`\n\n- slug `text` NOT NULL\n\n- label `text` NOT NULL\n\n- rank `integer(32)` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n## ticket_attachments\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- ticket_id `uuid` NOT NULL\n\n- comment_id `uuid`\n\n- storage_path `text` NOT NULL\n\n- public_url `text` NOT NULL\n\n- original_filename `text`\n\n- file_size `integer(32)`\n\n- mime_type `text`\n\n- uploaded_by_type `text` NOT NULL\n\n- uploaded_by_user_id `uuid`\n\n- source `text`\n\n- created_at `timestamp with time zone`\n\n## ticket_comments\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- ticket_id `uuid` NOT NULL\n\n- author_type `text` NOT NULL\n\n- author_user_id `uuid`\n\n- author_name `text` NOT NULL\n\n- comment_text `text` NOT NULL\n\n- is_resolution `boolean`\n\n- metadata `jsonb`\n\n- read_by_customer `boolean`\n\n- read_by_tech `boolean`\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n- edited `boolean`\n\n## ticket_notifications\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- ticket_id `uuid` NOT NULL\n\n- notification_type `text` NOT NULL\n\n- recipient_type `text` NOT NULL\n\n- recipient_phone `text`\n\n- recipient_email `text`\n\n- recipient_user_id `uuid`\n\n- message_body `text` NOT NULL\n\n- sms_sent `boolean`\n\n- email_sent `boolean`\n\n- sms_sent_at `timestamp with time zone`\n\n- email_sent_at `timestamp with time zone`\n\n- metadata `jsonb`\n\n- created_at `timestamp with time zone` NOT NULL\n\n- read_at `timestamp with time zone`\n\n## ticket_status_history\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- ticket_id `uuid` NOT NULL\n\n- from_status `USER-DEFINED`\n\n- to_status `USER-DEFINED` NOT NULL\n\n- changed_by_type `text` NOT NULL\n\n- changed_by_user_id `uuid`\n\n- changed_by_name `text`\n\n- reason `text`\n\n- created_at `timestamp with time zone` NOT NULL\n\n## tickets\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- external_id `text`\n\n- session_id `uuid`\n\n- owner_id `uuid`\n\n- van_id `uuid`\n\n- category_id `uuid`\n\n- owner_name `text` NOT NULL\n\n- phone `text` NOT NULL\n\n- email `text` NOT NULL\n\n- vin `text`\n\n- van_model_year `text`\n\n- issue_summary `text` NOT NULL\n\n- urgency `USER-DEFINED` NOT NULL\n\n- preferred_callback `text`\n\n- status `USER-DEFINED` NOT NULL\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n- ticket_number `integer(32)` NOT NULL\n\n- subject `text`\n\n- description `text`\n\n- priority `text`\n\n- assigned_to `uuid`\n\n- assigned_at `timestamp with time zone`\n\n- resolved_by `uuid`\n\n- resolved_at `timestamp with time zone`\n\n- closed_by `uuid`\n\n- closed_at `timestamp with time zone`\n\n- resolution `text`\n\n- tags `ARRAY`\n\n- metadata `jsonb`\n\n- last_customer_reply_at `timestamp with time zone`\n\n- last_tech_reply_at `timestamp with time zone`\n\n- has_unread_customer_comments `boolean`\n\n- has_unread_tech_comments `boolean`\n\n- related_ticket_id `uuid`\n\n- sequence_session_id `uuid`\n\n- reported_by_phone `text`\n\n## topic_patterns\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- category_slug `text` NOT NULL\n\n- pattern `text` NOT NULL\n\n- flags `text`\n\n- priority `integer(32)`\n\n- action_type `text`\n\n- action_key `text` NOT NULL\n\n- entry_step_id `text`\n\n- is_active `boolean`\n\n- created_at `timestamp with time zone`\n\n- updated_at `timestamp with time zone`\n\n- van_makes `ARRAY`\n\n- years `ARRAY`\n\n- van_versions `ARRAY`\n\n## user_roles\n- user_id `uuid` NOT NULL **PRIMARY KEY**\n\n- role_id `uuid` NOT NULL **PRIMARY KEY**\n\n- assigned_at `timestamp with time zone`\n\n## users\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n## users\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- email `text` NOT NULL\n\n- password_hash `text`\n\n- full_name `text`\n\n- created_at `timestamp with time zone`\n\n- updated_at `timestamp with time zone`\n\n- last_login `timestamp with time zone`\n\n- is_active `boolean`\n\n- phone `text`\n\n- notify_new_tickets `boolean`\n\n## vans\n- id `uuid` NOT NULL **PRIMARY KEY**\n\n- owner_id `uuid`\n\n- vin `text`\n\n- year `integer(32)` NOT NULL\n\n- van_number `text`\n\n- created_at `timestamp with time zone` NOT NULL\n\n- updated_at `timestamp with time zone` NOT NULL\n\n- make `text` NOT NULL\n\n- version `text`\n\n---\n\n## FOREIGN KEYS\n\n- `category_patterns.category_id` → `categories.id` (DELETE: CASCADE)\n- `doc_chunks.source_id` → `doc_sources.id` (DELETE: CASCADE)\n- `escalations.session_id` → `sessions.id` (DELETE: CASCADE)\n- `links_sent.session_id` → `sessions.id` (DELETE: SET NULL)\n- `playbook_forms_submissions.category_id` → `categories.id` (DELETE: SET NULL)\n- `playbooks_draft.category_id` → `categories.id` (DELETE: SET NULL)\n- `playbooks_published.category_id` → `categories.id` (DELETE: SET NULL)\n- `sequence_parts.sequence_key` → `sequences_metadata.sequence_key` (DELETE: CASCADE)\n- `sequence_sessions.sequence_key` → `sequences_metadata.sequence_key` (DELETE: NO ACTION)\n- `sequence_sessions.session_id` → `sessions.id` (DELETE: NO ACTION)\n- `sequence_sessions.van_id` → `vans.id` (DELETE: NO ACTION)\n- `sequence_step_responses.sequence_session_id` → `sequence_sessions.id` (DELETE: CASCADE)\n- `sequence_tools.sequence_key` → `sequences_metadata.sequence_key` (DELETE: CASCADE)\n- `session_events.session_id` → `sessions.id` (DELETE: CASCADE)\n- `session_paths.session_id` → `sessions.id` (DELETE: CASCADE)\n- `sessions.owner_id` → `owners.id` (DELETE: SET NULL)\n- `sessions.van_id` → `vans.id` (DELETE: SET NULL)\n- `sms_messages.sequence_session_id` → `sequence_sessions.id` (DELETE: NO ACTION)\n- `sms_messages.session_id` → `sessions.id` (DELETE: NO ACTION)\n- `step_handoff_triggers.sequence_key` → `doc_sequences.sequence_key` (DELETE: CASCADE)\n- `step_handoff_triggers.sequence_key` → `doc_sequences.step_num` (DELETE: CASCADE)\n- `step_handoff_triggers.step_num` → `doc_sequences.step_num` (DELETE: CASCADE)\n- `step_handoff_triggers.step_num` → `doc_sequences.sequence_key` (DELETE: CASCADE)\n- `step_handoff_triggers.target_sequence_key` → `sequences_metadata.sequence_key` (DELETE: RESTRICT)\n- `subcategories.category_id` → `categories.id` (DELETE: CASCADE)\n- `symptom_archetypes.category_id` → `categories.id` (DELETE: CASCADE)\n- `symptom_archetypes.subcategory_id` → `subcategories.id` (DELETE: SET NULL)\n- `ticket_attachments.comment_id` → `ticket_comments.id` (DELETE: SET NULL)\n- `ticket_attachments.ticket_id` → `tickets.id` (DELETE: CASCADE)\n- `ticket_attachments.uploaded_by_user_id` → `users.id` (DELETE: SET NULL)\n- `ticket_comments.author_user_id` → `users.id` (DELETE: NO ACTION)\n- `ticket_comments.ticket_id` → `tickets.id` (DELETE: CASCADE)\n- `ticket_notifications.recipient_user_id` → `users.id` (DELETE: NO ACTION)\n- `ticket_notifications.ticket_id` → `tickets.id` (DELETE: CASCADE)\n- `ticket_status_history.changed_by_user_id` → `users.id` (DELETE: NO ACTION)\n- `ticket_status_history.ticket_id` → `tickets.id` (DELETE: CASCADE)\n- `tickets.assigned_to` → `users.id` (DELETE: NO ACTION)\n- `tickets.category_id` → `categories.id` (DELETE: SET NULL)\n- `tickets.closed_by` → `users.id` (DELETE: NO ACTION)\n- `tickets.owner_id` → `owners.id` (DELETE: SET NULL)\n- `tickets.related_ticket_id` → `tickets.id` (DELETE: NO ACTION)\n- `tickets.resolved_by` → `users.id` (DELETE: NO ACTION)\n- `tickets.sequence_session_id` → `sequence_sessions.id` (DELETE: NO ACTION)\n- `tickets.session_id` → `sessions.id` (DELETE: SET NULL)\n- `tickets.van_id` → `vans.id` (DELETE: SET NULL)\n- `user_roles.role_id` → `roles.id` (DELETE: CASCADE)\n- `user_roles.user_id` → `users.id` (DELETE: CASCADE)\n- `vans.owner_id` → `owners.id` (DELETE: CASCADE)\n\n---\n\n## TRIGGERS\n\n- **update_doc_sequences_updated_at** on `doc_sequences` (BEFORE UPDATE) → update_updated_at_column\n- **update_sequence_parts_updated_at** on `sequence_parts` (BEFORE UPDATE) → update_updated_at_column\n- **update_sequence_tools_updated_at** on `sequence_tools` (BEFORE UPDATE) → update_updated_at_column\n- **update_sequences_metadata_updated_at** on `sequences_metadata` (BEFORE UPDATE) → update_updated_at_column\n- **update_ticket_comments_updated_at** on `ticket_comments` (BEFORE UPDATE) → update_updated_at_column\n\n---\n\n## INDEXES\n\n- **categories_slug_key** on `categories`\n- **ix_category_patterns_active** on `category_patterns`\n- **doc_chunks_keywords_gin** on `doc_chunks`\n- **doc_chunks_source_idx** on `doc_chunks`\n- **idx_doc_sequences_active** on `doc_sequences`\n- **idx_doc_sequences_key** on `doc_sequences`\n- **emergency_rules_scope_pattern_flags_key** on `emergency_rules`\n- **mv_kpi_monthly_month_idx** on `mv_kpi_monthly`\n- **mv_playbook_eff_key_ver_idx** on `mv_playbook_effectiveness`\n- **mv_step_transitions_key_ver_idx** on `mv_step_transitions`\n- **mv_step_visits_key_ver_idx** on `mv_step_visits`\n- **idx_owners_phone_normalized** on `owners`\n- **owners_phone_key** on `owners`\n- **idx_ptp_active** on `playbook_topic_patterns`\n- **idx_ptp_cat_prio** on `playbook_topic_patterns`\n- **playbooks_published_active_idx** on `playbooks_published`\n- **playbooks_published_key_version_uidx** on `playbooks_published`\n- **playbooks_published_playbook_key_unique** on `playbooks_published`\n- **idx_quick_responses_active** on `quick_responses`\n- **roles_name_key** on `roles`\n- **idx_sequence_parts_seq_step** on `sequence_parts`\n- **idx_sequence_sessions_active** on `sequence_sessions`\n- **idx_sequence_sessions_phone_normalized** on `sequence_sessions`\n- **idx_sequence_sessions_sequence_key** on `sequence_sessions`\n- **sequence_sessions_active_unique** on `sequence_sessions`\n- **sequence_sessions_completed_at_idx** on `sequence_sessions`\n- **sequence_sessions_phone_number_idx** on `sequence_sessions`\n- **sequence_sessions_sequence_key_idx** on `sequence_sessions`\n- **sequence_sessions_started_at_idx** on `sequence_sessions`\n- **sequence_sessions_status_idx** on `sequence_sessions`\n- **sequence_sessions_van_id_idx** on `sequence_sessions`\n- **idx_step_responses_session** on `sequence_step_responses`\n- **idx_step_responses_time** on `sequence_step_responses`\n- **idx_sequence_tools_seq_step** on `sequence_tools`\n- **session_events_session_time_idx** on `session_events`\n- **sessions_call_id_idx** on `sessions`\n- **sessions_call_id_unique** on `sessions`\n- **sessions_created_at_idx** on `sessions`\n- **sessions_owner_idx** on `sessions`\n- **sessions_status_started_idx** on `sessions`\n- **idx_sms_messages_from_phone_normalized** on `sms_messages`\n- **idx_sms_messages_phone** on `sms_messages`\n- **idx_sms_messages_to_phone_normalized** on `sms_messages`\n- **idx_sms_messages_unprocessed** on `sms_messages`\n- **sms_messages_created_at_idx** on `sms_messages`\n- **idx_sms_routing_state_active_phone** on `sms_routing_state`\n- **idx_sms_routing_state_expires** on `sms_routing_state`\n- **idx_sms_routing_state_phone** on `sms_routing_state`\n- **idx_step_handoff_triggers_source** on `step_handoff_triggers`\n- **subcategories_category_id_idx** on `subcategories`\n- **subcategories_slug_key** on `subcategories`\n- **symptom_archetypes_slug_key** on `symptom_archetypes`\n- **idx_ticket_attachments_comment** on `ticket_attachments`\n- **idx_ticket_attachments_created** on `ticket_attachments`\n- **idx_ticket_attachments_ticket** on `ticket_attachments`\n- **idx_ticket_comments_ticket_id** on `ticket_comments`\n- **idx_ticket_comments_unread_customer** on `ticket_comments`\n- **idx_ticket_comments_unread_tech** on `ticket_comments`\n- **idx_ticket_notifications_pending** on `ticket_notifications`\n- **idx_ticket_notifications_ticket** on `ticket_notifications`\n- **idx_ticket_notifications_unread_user** on `ticket_notifications`\n- **idx_ticket_status_history_ticket** on `ticket_status_history`\n- **idx_tickets_assigned_to** on `tickets`\n- **idx_tickets_phone_normalized** on `tickets`\n- **idx_tickets_priority** on `tickets`\n- **idx_tickets_reported_by_phone** on `tickets`\n- **idx_tickets_reported_by_phone_normalized** on `tickets`\n- **idx_tickets_sequence_session** on `tickets`\n- **idx_tickets_unassigned** on `tickets`\n- **tickets_created_status_idx** on `tickets`\n- **tickets_ticket_number_key** on `tickets`\n- **idx_topic_patterns_active** on `topic_patterns`\n- **idx_user_roles_role_id** on `user_roles`\n- **idx_user_roles_user_id** on `user_roles`\n- **idx_users_email** on `users`\n- **users_email_key** on `users`\n- **vans_make_idx** on `vans`\n- **vans_owner_id_idx** on `vans`\n- **vans_van_number_unique** on `vans`\n- **vans_version_idx** on `vans`\n- **vans_vin_key** on `vans`\n- **vans_year_idx** on `vans`\n\n---\n\n## ENUM TYPES\n\n- **ended_reason**: fixed, escalated, ticket_created, caller_hung_up, abandoned, unknown\n- **event_type**: question, answer, action, link, escalate, ticket, transfer, end, emergency_escalation\n- **session_status**: open, escalated, closed\n- **ticket_status**: open, pending, resolved, closed, assigned, in_progress, waiting_customer, cancelled\n- **urgency_level**: low, medium, high\n\n---\n\n## FUNCTIONS\n\n- **cleanup_expired_routing_states**() → integer\n- **clear_routing_state**(p_phone text) → boolean\n- **create_sequence_session**(p_phone text, p_sequence_key text, p_call_id text, p_van_number text, p_van_make text, p_van_version text, p_van_year integer) → TABLE(id uuid, message_template text, doc_url text, doc_title text, phone_number text)\n- **find_best_pattern_match**(p_message text) → TABLE(action_type text, action_key text, category_slug text, entry_step_id text, is_emergency boolean)\n- **find_best_pattern_match**(p_user_message text, p_van_make text DEFAULT NULL::text, p_van_version text DEFAULT NULL::text, p_van_year integer DEFAULT NULL::integer) → TABLE(action_type text, action_key text, entry_step_id text, priority integer)\n- **fn_add_sequence_part**(p_sequence_key text, p_part_name text, p_part_number text DEFAULT NULL::text, p_part_description text DEFAULT NULL::text, p_part_link text DEFAULT NULL::text, p_estimated_price numeric DEFAULT NULL::numeric, p_is_required boolean DEFAULT true, p_sort_order integer DEFAULT 0) → uuid\n- **fn_add_sequence_part**(p_sequence_key text, p_part_name text, p_part_number text DEFAULT NULL::text, p_part_description text DEFAULT NULL::text, p_part_link text DEFAULT NULL::text, p_estimated_price numeric DEFAULT NULL::numeric, p_is_required boolean DEFAULT true, p_sort_order integer DEFAULT 0, p_step_num integer DEFAULT NULL::integer) → uuid\n- **fn_add_sequence_step**(p_sequence_key text, p_step_num integer, p_message_template text, p_doc_url text DEFAULT NULL::text, p_doc_title text DEFAULT NULL::text, p_success_triggers text[] DEFAULT ARRAY['FIXED'::text, 'YES'::text, 'DONE'::text], p_failure_triggers text[] DEFAULT ARRAY['NO'::text, 'HELP'::text, 'NOT WORKING'::text]) → boolean\n- **fn_add_sequence_tool**(p_sequence_key text, p_tool_name text, p_tool_description text DEFAULT NULL::text, p_tool_link text DEFAULT NULL::text, p_is_required boolean DEFAULT true, p_sort_order integer DEFAULT 0) → uuid\n- **fn_add_sequence_tool**(p_sequence_key text, p_tool_name text, p_tool_description text DEFAULT NULL::text, p_tool_link text DEFAULT NULL::text, p_is_required boolean DEFAULT true, p_sort_order integer DEFAULT 0, p_step_num integer DEFAULT NULL::integer) → uuid\n- **fn_add_ticket_comment**(p_ticket_id uuid, p_comment_text text, p_author_type text, p_author_user_id uuid DEFAULT NULL::uuid, p_author_name text DEFAULT 'Anonymous'::text, p_is_resolution boolean DEFAULT false) → uuid\n- **fn_assign_ticket**(p_ticket_id uuid, p_tech_user_id uuid, p_assigned_by_user_id uuid DEFAULT NULL::uuid) → boolean\n- **fn_build_and_save_session_path**(p_session_id uuid, p_playbook_key text, p_version integer) → void\n- **fn_close_sequence**(p_sequence_session_id uuid, p_status text DEFAULT 'completed'::text, p_create_ticket boolean DEFAULT false, p_closed_by text DEFAULT NULL::text) → TABLE(success boolean, message text, ticket_id uuid, ticket_number integer)\n- **fn_close_session**(p_session_id uuid, p_reason ended_reason) → void\n- **fn_create_sequence**(p_sequence_key text, p_display_name text, p_description text DEFAULT NULL::text, p_category text DEFAULT NULL::text, p_created_by text DEFAULT NULL::text, p_first_step_message text DEFAULT 'First troubleshooting step'::text, p_first_step_url text DEFAULT NULL::text, p_first_step_title text DEFAULT NULL::text) → uuid\n- **fn_create_ticket**(p_phone text, p_email text DEFAULT 'unknown@example.com'::text, p_owner_name text DEFAULT 'Unknown'::text, p_issue_summary text DEFAULT NULL::text, p_subject text DEFAULT NULL::text, p_description text DEFAULT NULL::text, p_urgency urgency_level DEFAULT 'medium'::urgency_level, p_priority text DEFAULT 'normal'::text, p_category_id uuid DEFAULT NULL::uuid, p_van_id uuid DEFAULT NULL::uuid, p_owner_id uuid DEFAULT NULL::uuid, p_sequence_session_id uuid DEFAULT NULL::uuid, p_session_id uuid DEFAULT NULL::uuid, p_reported_by_phone text DEFAULT NULL::text) → uuid\n- **fn_delete_sequence**(p_sequence_key text) → boolean\n- **fn_delete_sequence_part**(p_part_id uuid) → boolean\n- **fn_delete_sequence_step**(p_sequence_key text, p_step_num integer) → boolean\n- **fn_delete_sequence_tool**(p_tool_id uuid) → boolean\n- **fn_get_active_sequences**() → TABLE(id uuid, phone_number text, sequence_key text, current_step integer, status text, started_at timestamp with time zone, last_interaction timestamp with time zone, handoff_count integer, sequence_name text, sequence_description text, van_number text, van_make text, van_version text, van_year integer, owner_name text, owner_phone text, minutes_since_last_interaction integer)\n- **fn_get_all_sequences**(p_include_inactive boolean DEFAULT false) → TABLE(sequence_key text, display_name text, description text, category text, is_active boolean, total_steps bigint, has_handoffs boolean, created_at timestamp with time zone, updated_at timestamp with time zone)\n- **fn_get_sequence_detail**(p_sequence_key text) → TABLE(sequence_key text, display_name text, description text, category text, sequence_active boolean, steps jsonb)\n- **fn_get_sequence_supplies**(p_sequence_key text) → TABLE(sequence_key text, display_name text, description text, tools jsonb, parts jsonb)\n- **fn_get_step_supplies**(p_sequence_key text, p_step_num integer) → TABLE(sequence_key text, step_num integer, tools jsonb, parts jsonb)\n- **fn_get_tech_tickets**(p_tech_user_id uuid DEFAULT NULL::uuid) → TABLE(ticket_id uuid, ticket_number integer, subject text, status ticket_status, priority text, urgency urgency_level, customer_name text, assigned_to_name text, created_at timestamp with time zone, last_activity timestamp with time zone, unread_customer_comments integer, total_comments integer)\n- **fn_get_ticket_attachments**(p_ticket_id uuid) → TABLE(id uuid, comment_id uuid, public_url text, original_filename text, mime_type text, uploaded_by_type text, created_at timestamp with time zone)\n- **fn_get_ticket_detail**(p_ticket_id uuid, p_viewer_type text DEFAULT 'customer'::text) → TABLE(ticket_id uuid, ticket_number integer, customer_name text, customer_phone text, customer_email text, subject text, description text, status ticket_status, priority text, urgency urgency_level, assigned_to_name text, resolution text, created_at timestamp with time zone, updated_at timestamp with time zone, resolved_at timestamp with time zone, van_number text, van_make text, van_version text, comments jsonb, total_comments integer, unread_count integer)\n- **fn_log_event**(p_session_id uuid, p_step_id text, p_event_type event_type, p_payload jsonb DEFAULT '{}'::jsonb, p_latency_ms integer DEFAULT NULL::integer) → uuid\n- **fn_log_link**(p_session_id uuid, p_to_phone text, p_url text, p_caption text DEFAULT NULL::text, p_sent_via text DEFAULT 'twilio'::text) → uuid\n- **fn_mark_comments_read**(p_ticket_id uuid, p_reader_type text) → integer\n- **fn_open_session**(p_call_id text, p_owner_id uuid DEFAULT NULL::uuid, p_van_id uuid DEFAULT NULL::uuid) → uuid\n- **fn_refresh_analytics**() → void\n- **fn_reopen_ticket**(p_original_ticket_id uuid, p_reason text, p_reopened_by_name text DEFAULT 'Customer'::text) → uuid\n- **fn_switch_playbook**(p_session_id uuid, p_next_playbook_key text, p_entry_step text, p_state_delta jsonb DEFAULT '{}'::jsonb) → void\n- **fn_toggle_sequence**(p_sequence_key text, p_is_active boolean) → boolean\n- **fn_update_sequence_metadata**(p_sequence_key text, p_display_name text DEFAULT NULL::text, p_description text DEFAULT NULL::text, p_category text DEFAULT NULL::text, p_is_active boolean DEFAULT NULL::boolean) → boolean\n- **fn_update_sequence_part**(p_part_id uuid, p_part_name text DEFAULT NULL::text, p_part_number text DEFAULT NULL::text, p_part_description text DEFAULT NULL::text, p_part_link text DEFAULT NULL::text, p_estimated_price numeric DEFAULT NULL::numeric, p_is_required boolean DEFAULT NULL::boolean, p_sort_order integer DEFAULT NULL::integer) → boolean\n- **fn_update_sequence_part**(p_part_id uuid, p_part_name text DEFAULT NULL::text, p_part_number text DEFAULT NULL::text, p_part_description text DEFAULT NULL::text, p_part_link text DEFAULT NULL::text, p_estimated_price numeric DEFAULT NULL::numeric, p_is_required boolean DEFAULT NULL::boolean, p_sort_order integer DEFAULT NULL::integer, p_step_num integer DEFAULT NULL::integer) → boolean\n- **fn_update_sequence_step**(p_sequence_key text, p_step_num integer, p_message_template text DEFAULT NULL::text, p_doc_url text DEFAULT NULL::text, p_doc_title text DEFAULT NULL::text, p_success_triggers text[] DEFAULT NULL::text[], p_failure_triggers text[] DEFAULT NULL::text[], p_handoff_trigger text DEFAULT NULL::text, p_handoff_sequence_key text DEFAULT NULL::text, p_is_active boolean DEFAULT NULL::boolean) → boolean\n- **fn_update_sequence_tool**(p_tool_id uuid, p_tool_name text DEFAULT NULL::text, p_tool_description text DEFAULT NULL::text, p_tool_link text DEFAULT NULL::text, p_is_required boolean DEFAULT NULL::boolean, p_sort_order integer DEFAULT NULL::integer) → boolean\n- **fn_update_sequence_tool**(p_tool_id uuid, p_tool_name text DEFAULT NULL::text, p_tool_description text DEFAULT NULL::text, p_tool_link text DEFAULT NULL::text, p_is_required boolean DEFAULT NULL::boolean, p_sort_order integer DEFAULT NULL::integer, p_step_num integer DEFAULT NULL::integer) → boolean\n- **fn_update_session**(p_session_id uuid, p_state jsonb DEFAULT NULL::jsonb, p_playbook_key text DEFAULT NULL::text, p_step_id text DEFAULT NULL::text) → void\n- **fn_update_ticket_status**(p_ticket_id uuid, p_new_status ticket_status, p_changed_by_type text DEFAULT 'tech'::text, p_changed_by_user_id uuid DEFAULT NULL::uuid, p_reason text DEFAULT NULL::text) → boolean\n- **fn_upsert_session_path**(p_session_id uuid, p_playbook_key text, p_version integer, p_step_sequence text[]) → void\n- **fn_validate_sequence**(p_sequence_key text) → TABLE(is_valid boolean, errors text[])\n- **get_ai_classifier_context**() → jsonb\n- **get_all_active_conversations**(p_phone text) → jsonb\n- **get_call_volume_heatmap**(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) → TABLE(day_of_week integer, hour_of_day integer, call_count bigint)\n- **get_chronic_problem_vans**(p_start_date timestamp with time zone DEFAULT (now() - '90 days'::interval), p_end_date timestamp with time zone DEFAULT now(), p_min_issues integer DEFAULT 3) → TABLE(van_number text, make text, version text, year integer, issue_count bigint, most_common_issue text, issue_frequency bigint, last_issue_date timestamp with time zone)\n- **get_dashboard_summary**(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) → TABLE(total_calls bigint, active_sequences bigint, completed_sequences bigint, escalated_sequences bigint, completion_rate numeric, avg_resolution_minutes numeric)\n- **get_first_contact_resolution**(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) → TABLE(sequence_key text, total_sequences bigint, resolved_step_1 bigint, resolved_any_step bigint, escalated bigint, fcr_rate numeric)\n- **get_handoff_patterns**(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) → TABLE(from_sequence text, to_sequence text, handoff_count bigint, avg_handoff_count numeric)\n- **get_issue_distribution**(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) → TABLE(issue_type text, total_count bigint, completed_count bigint, escalated_count bigint, success_rate numeric)\n- **get_or_create_van**(p_van_number text, p_van_make text, p_van_version text, p_van_year integer) → uuid\n- **get_resolution_by_step**(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) → TABLE(sequence_key text, step_num integer, resolved_count bigint, percentage numeric)\n- **get_resolution_time_trend**(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now(), p_interval text DEFAULT 'day'::text) → TABLE(time_bucket timestamp with time zone, avg_minutes numeric, total_resolved bigint)\n- **get_routing_state**(p_phone text) → TABLE(id uuid, state text, pending_action jsonb, conversation_options jsonb, confirmation_attempts integer, original_message text, expires_at timestamp with time zone)\n- **get_user_permissions**(p_user_id uuid) → jsonb\n- **get_user_response_patterns**(p_sequence_key text DEFAULT NULL::text, p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) → TABLE(sequence_key text, step_num integer, response_text text, response_count bigint, matched_trigger text)\n- **get_user_roles**(p_user_id uuid) → TABLE(role_name text, role_description text, permissions jsonb)\n- **get_van_performance**(p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval), p_end_date timestamp with time zone DEFAULT now()) → TABLE(make text, version text, year integer, total_issues bigint, avg_resolution_time numeric, escalation_rate numeric, reliability_score numeric)\n- **handle_sms_response**(p_phone text, p_message text) → TABLE(action text, message text, create_ticket boolean, needs_ai_interpretation boolean, current_step_context jsonb)\n- **normalize_phone**(p_phone text) → text\n- **test_pattern_match**(p_pattern text, p_test_string text, p_van_make text DEFAULT NULL::text, p_van_version text DEFAULT NULL::text, p_van_year integer DEFAULT NULL::integer) → boolean\n- **update_updated_at_column**() → trigger\n- **upsert_routing_state**(p_phone text, p_state text, p_pending_action jsonb DEFAULT NULL::jsonb, p_conversation_options jsonb DEFAULT NULL::jsonb, p_selected_id uuid DEFAULT NULL::uuid, p_selected_type text DEFAULT NULL::text, p_original_message text DEFAULT NULL::text, p_increment_attempts boolean DEFAULT false) → uuid\n- **user_has_permission**(p_user_id uuid, p_permission text) → boolean\n- **util_schema_report**(schemas text[] DEFAULT NULL::text[]) → jsonb",
    "generated_at": "2026-01-26 19:38:16.192797+00"
  }
]